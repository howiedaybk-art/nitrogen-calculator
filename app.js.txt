// Основные константы и переменные
const STORAGE_KEY = 'nitrogen_calculator_data';
const HISTORY_KEY = 'nitrogen_calculator_history';
let calculationHistory = [];

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadSavedData();
    loadHistory();
    updateHistoryTable();
    
    // Обработчик формы
    document.getElementById('nitrogenForm').addEventListener('submit', function(e) {
        e.preventDefault();
        calculateNitrogen();
    });
    
    // Автоматический расчет при изменении значений
    const inputs = ['currentLevel', 'consumptionRate', 'minLevel', 'deliveryDays', 'orderVolume'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('change', saveData);
    });
});

// Функция расчета
function calculateNitrogen() {
    // Получаем значения из формы
    const current = parseFloat(document.getElementById('currentLevel').value);
    const rate = parseFloat(document.getElementById('consumptionRate').value);
    const min = parseFloat(document.getElementById('minLevel').value);
    const delivery = parseInt(document.getElementById('deliveryDays').value);
    const orderVolume = parseInt(document.getElementById('orderVolume').value);
    
    // Проверка введенных данных
    if (isNaN(current) || isNaN(rate) || rate <= 0) {
        showError("Пожалуйста, заполните все поля корректно!");
        return;
    }
    
    if (current <= min) {
        showError("Текущий уровень уже на или ниже минимального остатка! Закажите срочно!");
        return;
    }
    
    // Расчет основных показателей
    const daysToMin = (current - min) / rate;
    const daysToOrder = daysToMin - delivery;
    const safeOrderDay = Math.floor(daysToOrder);
    
    // Расчет дат
    const today = new Date();
    const orderDate = new Date(today);
    orderDate.setDate(orderDate.getDate() + safeOrderDay);
    
    const arrivalDate = new Date(orderDate);
    arrivalDate.setDate(arrivalDate.getDate() + delivery);
    
    const depletionDate = new Date(today);
    depletionDate.setDate(depletionDate.getDate() + Math.ceil(daysToMin));
    
    // Определение статуса
    let status, statusClass, statusIcon;
    if (daysToOrder <= 0) {
        status = "СРОЧНО ЗАКАЗАТЬ!";
        statusClass = "urgent";
        statusIcon = "bi-exclamation-triangle-fill text-danger";
    } else if (daysToOrder <= 2) {
        status = "Рекомендуется заказать в ближайшие дни";
        statusClass = "warning";
        statusIcon = "bi-exclamation-circle-fill text-warning";
    } else {
        status = "Запас достаточный";
        statusClass = "normal";
        statusIcon = "bi-check-circle-fill text-success";
    }
    
    // Форматирование результатов
    const resultHTML = `
        <div class="alert ${statusClass}">
            <h4><i class="bi ${statusIcon}"></i> ${status}</h4>
            <hr>
            <div class="row text-start">
                <div class="col-md-6">
                    <p><strong>Дней до минимального уровня:</strong><br>
                    <span class="fs-4">${daysToMin.toFixed(1)}</span> дней</p>
                    
                    <p><strong>Дата исчерпания запаса:</strong><br>
                    ${depletionDate.toLocaleDateString('ru-RU')}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Рекомендуемая дата заказа:</strong><br>
                    <span class="fs-4">${orderDate.toLocaleDateString('ru-RU')}</span></p>
                    
                    <p><strong>Ожидаемая дата поставки:</strong><br>
                    ${arrivalDate.toLocaleDateString('ru-RU')}</p>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">После поставки уровень составит примерно ${Math.min(current + orderVolume, 100).toFixed(0)}%</small>
            </div>
        </div>
    `;
    
    // Обновление прогресс-бара
    const progressPercent = Math.min(100, (current / 100) * 100);
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = `${progressPercent}%`;
    progressBar.textContent = `${current.toFixed(0)}%`;
    progressBar.className = `progress-bar ${getProgressBarColor(current, min)}`;
    
    // Обновление текстовой информации
    document.getElementById('currentLevelText').textContent = `${current.toFixed(0)}%`;
    document.getElementById('minLevelText').textContent = `${min}%`;
    document.getElementById('daysText').textContent = daysToMin.toFixed(1);
    
    // Отображение результатов
    document.getElementById('result').innerHTML = resultHTML;
    
    // Сохранение в историю
    addToHistory(current, rate, min, delivery, orderVolume, daysToOrder, status);
    
    // Сохранение данных
    saveData();
}

// Функция для быстрой установки уровня
function setQuickLevel(level) {
    document.getElementById('currentLevel').value = level;
    calculateNitrogen();
}

// Функция добавления в историю
function addToHistory(current, rate, min, delivery, orderVolume, daysToOrder, status) {
    const historyEntry = {
        date: new Date().toLocaleString('ru-RU'),
        timestamp: new Date().getTime(),
        currentLevel: current,
        consumptionRate: rate,
        minLevel: min,
        deliveryDays: delivery,
        daysToOrder: daysToOrder,
        status: status
    };
    
    calculationHistory.unshift(historyEntry); // Добавляем в начало
    
    // Сохраняем только последние 50 записей
    if (calculationHistory.length > 50) {
        calculationHistory = calculationHistory.slice(0, 50);
    }
    
    localStorage.setItem(HISTORY_KEY, JSON.stringify(calculationHistory));
    updateHistoryTable();
}

// Функция обновления таблицы истории
function updateHistoryTable() {
    const tbody = document.getElementById('historyTable');
    const info = document.getElementById('historyInfo');
    
    if (calculationHistory.length === 0) {
        tbody.innerHTML = '';
        info.textContent = 'Нет сохраненных замеров';
        return;
    }
    
    info.textContent = `Всего записей: ${calculationHistory.length}`;
    
    tbody.innerHTML = calculationHistory.map(entry => `
        <tr class="${getStatusClass(entry.status)}">
            <td>${entry.date.split(',')[0]}</td>
            <td>${entry.currentLevel.toFixed(0)}%</td>
            <td>${entry.consumptionRate.toFixed(2)}%/день</td>
            <td>${entry.daysToOrder > 0 ? entry.daysToOrder.toFixed(1) + ' дн.' : '<span class="text-danger">СРОЧНО</span>'}</td>
        </tr>
    `).join('');
}

// Функция загрузки истории
function loadHistory() {
    const savedHistory = localStorage.getItem(HISTORY_KEY);
    if (savedHistory) {
        calculationHistory = JSON.parse(savedHistory);
    }
}

// Функция очистки истории
function clearHistory() {
    if (confirm("Вы уверены, что хотите очистить всю историю замеров?")) {
        calculationHistory = [];
        localStorage.removeItem(HISTORY_KEY);
        updateHistoryTable();
    }
}

// Функция загрузки сохраненных данных
function loadSavedData() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        const data = JSON.parse(savedData);
        document.getElementById('currentLevel').value = data.currentLevel || '';
        document.getElementById('consumptionRate').value = data.consumptionRate || '';
        document.getElementById('minLevel').value = data.minLevel || 15;
        document.getElementById('deliveryDays').value = data.deliveryDays || 2;
        document.getElementById('orderVolume').value = data.orderVolume || 80;
    }
}

// Функция сохранения данных
function saveData() {
    const data = {
        currentLevel: document.getElementById('currentLevel').value,
        consumptionRate: document.getElementById('consumptionRate').value,
        minLevel: document.getElementById('minLevel').value,
        deliveryDays: document.getElementById('deliveryDays').value,
        orderVolume: document.getElementById('orderVolume').value
    };
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Вспомогательные функции
function showError(message) {
    document.getElementById('result').innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-octagon-fill"></i> ${message}
        </div>
    `;
}

function getProgressBarColor(current, min) {
    if (current <= min * 1.5) return 'bg-danger';
    if (current <= min * 2.5) return 'bg-warning';
    return 'bg-success';
}

function getStatusClass(status) {
    if (status.includes('СРОЧНО')) return 'table-danger';
    if (status.includes('Рекомендуется')) return 'table-warning';
    return 'table-success';
}

// Автоматический расчет при загрузке, если есть данные
window.onload = function() {
    const savedData = localStorage.getItem(STORAGE_KEY);
    if (savedData) {
        const data = JSON.parse(savedData);
        if (data.currentLevel && data.consumptionRate) {
            setTimeout(calculateNitrogen, 500);
        }
    }
};